version: '3'

vars:
  VPS_HOST: 217.12.37.51
  VPS_USER: root
  VPS_PATH: /root/deploy/selectel-test  # –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ –≥–¥–µ docker-compose.yml
  CONTAINER_NAME: fischuk_test_keycloak
  POSTGRES_CONTAINER: fischuk_test_postgres
  REALM_NAME: Woman

tasks:
  # === –û–°–ù–û–í–ù–´–ï –°–ï–†–í–ò–°–´ ===
  app:start:
    desc: "–ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ (–±–µ–∑ Swagger)"
    cmds:
      - |
        echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã..."
        ssh {{.VPS_USER}}@{{.VPS_HOST}} << 'EOF'
        cd {{.VPS_PATH}}
        
        docker-compose up -d postgres_test keycloak_test
        
        echo "‚úÖ –û—Å–Ω–æ–≤–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã"
        EOF

  app:start:with-docs:
    desc: "–ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –≤–º–µ—Å—Ç–µ —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π"
    cmds:
      - |
        echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π..."
        ssh {{.VPS_USER}}@{{.VPS_HOST}} << 'EOF'
        cd {{.VPS_PATH}}
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
        docker-compose up -d postgres_test keycloak_test
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
        docker-compose -f docker-compose.swagger.yml --profile docs up -d
        
        echo "‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã:"
        echo "üîê Keycloak: https://alex-fisher-team.ru:33011/be"
        echo "üìñ Swagger: https://alex-fisher-team.ru:33012"
        EOF

  app:stop:
    desc: "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤"
    cmds:
      - |
        echo "‚èπÔ∏è –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã..."
        ssh {{.VPS_USER}}@{{.VPS_HOST}} << 'EOF'
        cd {{.VPS_PATH}}
        
        docker-compose down
        docker-compose -f docker-compose.swagger.yml down
        
        echo "‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
        EOF

  keycloak:backup:simple:
    desc: "–ë–µ–∫–∞–ø realm –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª"
    vars:
      TIMESTAMP: '{{now | date "2006-01-02_15-04-05"}}'
    cmds:
      - |
        echo "üì• –°–æ–∑–¥–∞–µ–º –±–µ–∫–∞–ø realm: {{.REALM_NAME}}"
        ssh {{.VPS_USER}}@{{.VPS_HOST}} << 'EOF'
        cd {{.VPS_PATH}}
        
        mkdir -p backups
        
        if [ -f test-realm.json ]; then
          cp test-realm.json backups/test-realm-backup-{{.TIMESTAMP}}.json
        fi
        
        # –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤ –û–î–ò–ù —Ñ–∞–π–ª
        echo "üì§ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º realm {{.REALM_NAME}} –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª..."
        docker exec {{.CONTAINER_NAME}} /opt/keycloak/bin/kc.sh export \
          --file /tmp/export-{{.REALM_NAME}}.json \
          --realm {{.REALM_NAME}} \
          --users skip
        
        echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Ñ–∞–π–ª:"
        docker exec {{.CONTAINER_NAME}} ls -la /tmp/export-{{.REALM_NAME}}.json
        
        # –ö–æ–ø–∏—Ä—É–µ–º –≥–æ—Ç–æ–≤—ã–π —Ñ–∞–π–ª (—É–∂–µ –≤–∞–ª–∏–¥–Ω—ã–π JSON!)
        docker exec {{.CONTAINER_NAME}} cat /tmp/export-{{.REALM_NAME}}.json > test-realm.json
        
        if [ -s test-realm.json ]; then
          echo "‚úÖ Realm {{.REALM_NAME}} —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω ($(wc -c < test-realm.json) –±–∞–π—Ç)"
          echo "üìÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º JSON:"
          head -2 test-realm.json
        else
          echo "‚ùå –§–∞–π–ª test-realm.json –ø—É—Å—Ç–æ–π!"
        fi
        EOF

  keycloak:backup:all-realms:
    desc: "–ë–µ–∫–∞–ø –≤—Å–µ—Ö realm'–æ–≤ –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª"
    vars:
      TIMESTAMP: '{{now | date "2006-01-02_15-04-05"}}'
    cmds:
      - |
        echo "üì• –°–æ–∑–¥–∞–µ–º –±–µ–∫–∞–ø –í–°–ï–• realm'–æ–≤..."
        ssh {{.VPS_USER}}@{{.VPS_HOST}} << 'EOF'
        cd {{.VPS_PATH}}
        
        mkdir -p backups
        
        if [ -f test-realm.json ]; then
          cp test-realm.json backups/test-realm-backup-{{.TIMESTAMP}}.json
        fi
        
        # –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –í–°–ï realm'—ã –≤ –û–î–ò–ù —Ñ–∞–π–ª
        echo "üì§ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ realm'—ã –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª..."
        docker exec {{.CONTAINER_NAME}} /opt/keycloak/bin/kc.sh export \
          --file /tmp/export-all-realms.json \
          --users skip
        
        echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Ñ–∞–π–ª:"
        docker exec {{.CONTAINER_NAME}} ls -la /tmp/export-all-realms.json
        
        # –ö–æ–ø–∏—Ä—É–µ–º –≥–æ—Ç–æ–≤—ã–π —Ñ–∞–π–ª
        docker exec {{.CONTAINER_NAME}} cat /tmp/export-all-realms.json > test-realm.json
        
        if [ -s test-realm.json ]; then
          echo "‚úÖ –í—Å–µ realm'—ã —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã ($(wc -c < test-realm.json) –±–∞–π—Ç)"
          echo "üìÑ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞:"
          head -5 test-realm.json
        else
          echo "‚ùå –§–∞–π–ª test-realm.json –ø—É—Å—Ç–æ–π!"
        fi
        EOF

  keycloak:backup:with-users:
    desc: "–ë–µ–∫–∞–ø —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª"
    vars:
      TIMESTAMP: '{{now | date "2006-01-02_15-04-05"}}'
      REALM_NAME: '{{.REALM_NAME | default "master"}}'
    cmds:
      - |
        echo "üì• –°–æ–∑–¥–∞–µ–º –ø–æ–ª–Ω—ã–π –±–µ–∫–∞–ø realm: {{.REALM_NAME}} (—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏)"
        ssh {{.VPS_USER}}@{{.VPS_HOST}} << 'EOF'
        cd {{.VPS_PATH}}
        
        mkdir -p backups
        
        # –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –° –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª
        echo "üì§ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º realm {{.REALM_NAME}} —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏..."
        docker exec {{.CONTAINER_NAME}} /opt/keycloak/bin/kc.sh export \
          --file /tmp/export-{{.REALM_NAME}}-full.json \
          --realm {{.REALM_NAME}} \
          --users realm_file
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω—ã–π –±–µ–∫–∞–ø –≤ –∞—Ä—Ö–∏–≤
        docker exec {{.CONTAINER_NAME}} cat /tmp/export-{{.REALM_NAME}}-full.json > backups/realm-{{.REALM_NAME}}-full-{{.TIMESTAMP}}.json
        
        # –î–ª—è –∞–≤—Ç–æ–∏–º–ø–æ—Ä—Ç–∞ —Å–æ–∑–¥–∞–µ–º –≤–µ—Ä—Å–∏—é –±–µ–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        docker exec {{.CONTAINER_NAME}} /opt/keycloak/bin/kc.sh export \
          --file /tmp/export-{{.REALM_NAME}}-config.json \
          --realm {{.REALM_NAME}} \
          --users skip
        
        docker exec {{.CONTAINER_NAME}} cat /tmp/export-{{.REALM_NAME}}-config.json > test-realm.json
        
        echo "‚úÖ –ü–æ–ª–Ω—ã–π –±–µ–∫–∞–ø —Å–æ–∑–¥–∞–Ω:"
        echo "- –° –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏: backups/realm-{{.REALM_NAME}}-full-{{.TIMESTAMP}}.json"
        echo "- –î–ª—è –∞–≤—Ç–æ–∏–º–ø–æ—Ä—Ç–∞: test-realm.json"
        EOF

  keycloak:backup:db:
    desc: "–ë–µ–∫–∞–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö PostgreSQL"
    vars:
      TIMESTAMP: '{{now | date "2006-01-02_15-04-05"}}'
    cmds:
      - |
        echo "üíæ –°–æ–∑–¥–∞–µ–º –±–µ–∫–∞–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
        ssh {{.VPS_USER}}@{{.VPS_HOST}} << 'EOF'
        cd {{.VPS_PATH}}  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
        mkdir -p backups
        
        echo "üì§ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö..."
        docker exec {{.POSTGRES_CONTAINER}} pg_dump -U ${POSTGRES_USER} ${POSTGRES_DB} \
          > backups/postgres-backup-{{.TIMESTAMP}}.sql
        
        echo "‚úÖ –ë–µ–∫–∞–ø –ë–î —Å–æ–∑–¥–∞–Ω: backups/postgres-backup-{{.TIMESTAMP}}.sql"
        EOF

  keycloak:restart:
    desc: "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Keycloak –Ω–∞ VPS"
    cmds:
      - |
        echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º Keycloak..."
        ssh {{.VPS_USER}}@{{.VPS_HOST}} << 'EOF'
        cd {{.VPS_PATH}}  # –ö–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ —Å docker-compose.yml
        
        docker restart {{.CONTAINER_NAME}}
        
        echo "‚è≥ –û–∂–∏–¥–∞–µ–º –∑–∞–ø—É—Å–∫–∞..."
        sleep 20
        
        echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å:"
        docker ps | grep keycloak
        
        echo "üìú –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ (–∏—â–µ–º –∏–º–ø–æ—Ä—Ç):"
        docker logs {{.CONTAINER_NAME}} --tail 10 | grep -i import || echo "–õ–æ–≥–∏ –∏–º–ø–æ—Ä—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
        
        echo "üåê Keycloak –¥–æ—Å—Ç—É–ø–µ–Ω: https://alex-fisher-team.ru/be"
        EOF

  keycloak:logs:
    desc: "–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ Keycloak"
    cmds:
      - |
        echo "üìã –õ–æ–≥–∏ Keycloak:"
        ssh {{.VPS_USER}}@{{.VPS_HOST}} "docker logs {{.CONTAINER_NAME}} --tail 30"

  keycloak:status:
    desc: "–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã –Ω–∞ VPS"
    cmds:
      - |
        echo "=== üöÄ –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã –Ω–∞ VPS root@217.12.37.51 ==="
        ssh {{.VPS_USER}}@{{.VPS_HOST}} << 'EOF'
        cd {{.VPS_PATH}}  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
        
        echo "üì¶ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:"
        docker ps | grep -E "(keycloak|postgres)" || echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–µ –∑–∞–ø—É—â–µ–Ω—ã"
        
        echo -e "\nüìÑ –§–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:"
        ls -la test-realm.json 2>/dev/null || echo "‚ùå test-realm.json –Ω–µ –Ω–∞–π–¥–µ–Ω"
        ls -la docker-compose.yml 2>/dev/null || echo "‚ùå docker-compose.yml –Ω–µ –Ω–∞–π–¥–µ–Ω"
        ls -la .env.test 2>/dev/null || echo "‚ùå .env.test –Ω–µ –Ω–∞–π–¥–µ–Ω"
        
        echo -e "\nüìÅ –ê—Ä—Ö–∏–≤–Ω—ã–µ –±–µ–∫–∞–ø—ã:"
        ls -la backups/ 2>/dev/null | tail -5 || echo "‚ùå –ü–∞–ø–∫–∞ backups –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
        
        echo -e "\nüíæ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞:"
        du -sh backups/ 2>/dev/null || echo "–ù–µ—Ç –±–µ–∫–∞–ø–æ–≤"
        
        echo -e "\nüìç –¢–µ–∫—É—â–∞—è –ø–∞–ø–∫–∞:"
        pwd
        ls -la
        EOF
        
        echo -e "\nüåê –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å:"
        curl -s -I https://alex-fisher-team.ru/be | head -1 || echo "‚ùå –°–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"

  keycloak:backup:full:
    desc: "–ü–æ–ª–Ω—ã–π –±–µ–∫–∞–ø: –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è + –ë–î"
    cmds:
      - task: keycloak:backup:simple
      - task: keycloak:backup:db
      - |
        echo "üì¶ –ü–æ–ª–Ω—ã–π –±–µ–∫–∞–ø –∑–∞–≤–µ—Ä—à–µ–Ω!"
        echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è: task keycloak:restart"

  keycloak:restore:
    desc: "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –∞—Ä—Ö–∏–≤–Ω–æ–≥–æ –±–µ–∫–∞–ø–∞"
    vars:
      BACKUP_FILE: '{{.BACKUP_FILE}}'
    cmds:
      - |
        if [ -z "{{.BACKUP_FILE}}" ]; then
          echo "‚ùå –£–∫–∞–∂–∏—Ç–µ —Ñ–∞–π–ª –±–µ–∫–∞–ø–∞:"
          echo "–ü—Ä–∏–º–µ—Ä: task keycloak:restore BACKUP_FILE=test-realm-backup-2024-01-15_14-30-00.json"
          echo ""
          echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –±–µ–∫–∞–ø—ã –Ω–∞ VPS:"
          ssh {{.VPS_USER}}@{{.VPS_HOST}} "ls -1 {{.VPS_PATH}}/backups/*realm*.json 2>/dev/null" || echo "–ù–µ—Ç –±–µ–∫–∞–ø–æ–≤"
          exit 1
        fi
      - |
        echo "üîÑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑: {{.BACKUP_FILE}}"
        ssh {{.VPS_USER}}@{{.VPS_HOST}} << 'EOF'
        cd {{.VPS_PATH}}  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
        
        if [ ! -f "backups/{{.BACKUP_FILE}}" ]; then
          echo "‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: backups/{{.BACKUP_FILE}}"
          exit 1
        fi
        
        cp "backups/{{.BACKUP_FILE}}" test-realm.json
        echo "‚úÖ –§–∞–π–ª –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: task keycloak:restart"
        EOF

  keycloak:clean:old-backups:
    desc: "–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±–µ–∫–∞–ø–æ–≤ (—Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π)"
    cmds:
      - |
        echo "üóëÔ∏è –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –±–µ–∫–∞–ø—ã..."
        ssh {{.VPS_USER}}@{{.VPS_HOST}} << 'EOF'
        cd {{.VPS_PATH}}/backups  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
        
        echo "–£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª—ã —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π:"
        find . -name "*.json" -o -name "*.sql" -mtime +30 -print -delete
        
        echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
        EOF

  vps:check-structure:
    desc: "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–∞–ø–æ–∫ –Ω–∞ VPS"
    cmds:
      - |
        echo "üìÅ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ VPS..."
        ssh {{.VPS_USER}}@{{.VPS_HOST}} << 'EOF'
        echo "üìç –ö–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞: {{.VPS_PATH}}"
        cd {{.VPS_PATH}}
        ls -la
        
        echo -e "\nüìÑ –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã:"
        echo "docker-compose.yml: $([ -f docker-compose.yml ] && echo '‚úÖ' || echo '‚ùå')"
        echo ".env.test: $([ -f .env.test ] && echo '‚úÖ' || echo '‚ùå')"
        echo "test-realm.json: $([ -f test-realm.json ] && echo '‚úÖ' || echo '‚ùå')"
        echo "init.sql: $([ -f init.sql ] && echo '‚úÖ' || echo '‚ùå')"
        EOF

  vps:connect:
    desc: "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ VPS"
    cmds:
      - ssh {{.VPS_USER}}@{{.VPS_HOST}}

  vps:test:
    desc: "–¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å VPS"
    cmds:
      - |
        echo "üîç –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å VPS..."
        ssh {{.VPS_USER}}@{{.VPS_HOST}} "echo '‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å VPS —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ' && whoami && pwd"

  # === –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –ö–û–ù–§–ò–ì–û–í ===
  config:copy:
    desc: "–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ config.docker.yaml –Ω–∞ VPS"
    cmds:
      - |
        echo "üìÅ –ö–æ–ø–∏—Ä—É–µ–º config.docker.yaml –Ω–∞ VPS..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
        if [ ! -f ../../configs/config.docker.yaml ]; then
          echo "‚ùå –§–∞–π–ª ../../configs/config.docker.yaml –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          echo "üí° –°–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ configs/config.example.yaml"
          exit 1
        fi
        
        # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É configs –Ω–∞ VPS
        echo "üìÇ –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É configs –Ω–∞ VPS..."
        ssh {{.VPS_USER}}@{{.VPS_HOST}} "mkdir -p {{.VPS_PATH}}/configs"
        
        # –ö–æ–ø–∏—Ä—É–µ–º –Ω–∞ VPS
        echo "üì§ –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª..."
        scp ../../configs/config.docker.yaml {{.VPS_USER}}@{{.VPS_HOST}}:{{.VPS_PATH}}/configs/
        
        echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω"

  config:check:
    desc: "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥ –Ω–∞ VPS"
    cmds:
      - |
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥ –Ω–∞ VPS..."
        ssh {{.VPS_USER}}@{{.VPS_HOST}} << 'EOF'
        cd {{.VPS_PATH}}
        
        if [ -f configs/config.docker.yaml ]; then
          echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥ –Ω–∞–π–¥–µ–Ω: configs/config.docker.yaml"
          echo "üìä –†–∞–∑–º–µ—Ä: $(wc -c < configs/config.docker.yaml) –±–∞–π—Ç"
          echo "üìÖ –î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è: $(stat -c %y configs/config.docker.yaml)"
        else
          echo "‚ùå –ö–æ–Ω—Ñ–∏–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω: configs/config.docker.yaml"
          echo "üí° –í—ã–ø–æ–ª–Ω–∏—Ç–µ: task config:copy"
        fi
        EOF

  config:view:
    desc: "–ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ–Ω—Ñ–∏–≥–∞ –Ω–∞ VPS"
    cmds:
      - |
        echo "üëÅÔ∏è –°–æ–¥–µ—Ä–∂–∏–º–æ–µ config.docker.yaml –Ω–∞ VPS:"
        ssh {{.VPS_USER}}@{{.VPS_HOST}} << 'EOF'
        cd {{.VPS_PATH}}
        
        if [ -f configs/config.docker.yaml ]; then
          cat configs/config.docker.yaml
        else
          echo "‚ùå –§–∞–π–ª configs/config.docker.yaml –Ω–µ –Ω–∞–π–¥–µ–Ω"
        fi
        EOF

  config:backup:
    desc: "–°–æ–∑–¥–∞—Ç—å –±–µ–∫–∞–ø —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞ –Ω–∞ VPS"
    vars:
      TIMESTAMP: '{{now | date "2006-01-02_15-04-05"}}'
    cmds:
      - |
        echo "üíæ –°–æ–∑–¥–∞–µ–º –±–µ–∫–∞–ø –∫–æ–Ω—Ñ–∏–≥–∞..."
        ssh {{.VPS_USER}}@{{.VPS_HOST}} << 'EOF'
        cd {{.VPS_PATH}}
        
        if [ -f configs/config.docker.yaml ]; then
          mkdir -p configs/backups
          cp configs/config.docker.yaml configs/backups/config.docker.yaml.{{.TIMESTAMP}}
          echo "‚úÖ –ë–µ–∫–∞–ø —Å–æ–∑–¥–∞–Ω: configs/backups/config.docker.yaml.{{.TIMESTAMP}}"
        else
          echo "‚ùå –§–∞–π–ª configs/config.docker.yaml –Ω–µ –Ω–∞–π–¥–µ–Ω"
        fi
        EOF

  # === –ö–û–ú–ë–ò–ù–ò–†–û–í–ê–ù–ù–´–ï –ó–ê–î–ê–ß–ò ===
  deploy:prepare:
    desc: "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –¥–µ–ø–ª–æ—é (–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞ + –±–µ–∫–∞–ø)"
    cmds:
      - task: config:backup
      - task: config:copy
      - task: config:check