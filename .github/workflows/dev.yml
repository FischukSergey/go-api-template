name: Docker Image CI Develop

on:
  workflow_dispatch:
  push:
    branches:
      - dev
#  pull_request:
#    branches:
#      - dev

env:
  # Docker Registry
  REGISTRY: cr.selcloud.ru
  IMAGE_NAME: woman-app-be/dev
  IMAGE_TAG: latest
  
  # VPS Configuration (—É–±–∏—Ä–∞–µ–º HOST –∏ USER)
  VPS_PATH: /root/deploy/selectel-test
  
  # Application Configuration
  APP_CONTAINER_NAME: woman-app-be-dev
  COMPOSE_FILE: docker-compose.dev.yaml

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: 'dev'

      - name: Log in to Selectel Registry
        env:
          SELECTEL_REGISTRY_TOKEN: ${{ secrets.SELECTEL_REGISTRY_TOKEN }}
          SELECTEL_REGISTRY_USERNAME: ${{ secrets.SELECTEL_REGISTRY_USERNAME }}
        run: |
          echo "$SELECTEL_REGISTRY_TOKEN" | docker login ${{ env.REGISTRY }} -u "$SELECTEL_REGISTRY_USERNAME" --password-stdin

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./dev.Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

  deploy:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - uses: actions/checkout@v4

      - name: Copy docker-compose files
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}       # ‚Üê –ò—Å–ø–æ–ª—å–∑—É–µ–º secrets
          username: ${{ secrets.VPS_USER }}   # ‚Üê –ò—Å–ø–æ–ª—å–∑—É–µ–º secrets
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "deploy/dev/"
          strip_components: 2
          target: ${{ env.VPS_PATH }}

      - name: Deploy to Selectel Cloud
        uses: appleboy/ssh-action@v0.1.5
        env:
          FULL_IMAGE_NAME: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          SELECTEL_REGISTRY_TOKEN: ${{ secrets.SELECTEL_REGISTRY_TOKEN }}
          SELECTEL_REGISTRY_USERNAME: ${{ secrets.SELECTEL_REGISTRY_USERNAME }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: FULL_IMAGE_NAME,SELECTEL_REGISTRY_TOKEN,SELECTEL_REGISTRY_USERNAME
          script: | 
            cd ${{ env.VPS_PATH }}
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞
            if [ ! -f configs/config.docker.yaml ]; then
              echo "‚ùå configs/config.docker.yaml –Ω–µ –Ω–∞–π–¥–µ–Ω!"
              echo "üí° –í—ã–ø–æ–ª–Ω–∏—Ç–µ: task config:copy –∏–∑ deploy/dev/"
              exit 1
            fi
            
            # –õ–û–ì–ò–ù–ò–ú–°–Ø –í REGISTRY –ù–ê VPS
            echo "$SELECTEL_REGISTRY_TOKEN" | docker login ${{ env.REGISTRY }} -u "$SELECTEL_REGISTRY_USERNAME" --password-stdin
            
            # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
            mkdir -p logs configs
            chmod -R 755 logs

            # Graceful shutdown
            docker compose -f ${{ env.COMPOSE_FILE }} down || true

            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã
            docker image rm $FULL_IMAGE_NAME || true

            # –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–∑—ã
            docker compose -f ${{ env.COMPOSE_FILE }} pull

            # –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            docker compose -f ${{ env.COMPOSE_FILE }} up -d
            
            echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
            docker ps | grep woman-app-be-dev 